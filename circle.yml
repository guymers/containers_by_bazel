machine:
  services:
    - docker
  java:
    version: oraclejdk8

dependencies:
  pre:
    # stop services that are running by default
    - sudo service mysql stop
    - sudo service postgresql stop 9.4
    - sudo service postgresql stop 9.5
    - sudo service redis-server stop
    - sudo apt-get update
    # http://bazel.io/docs/install.html
    - sudo apt-get install -y pkg-config zip g++ zlib1g-dev unzip
    - wget https://github.com/bazelbuild/bazel/releases/download/0.2.2b/bazel_0.2.2b-linux-x86_64.deb.sha256
    - wget https://github.com/bazelbuild/bazel/releases/download/0.2.2b/bazel_0.2.2b-linux-x86_64.deb
    - sha256sum -c bazel_0.2.2b-linux-x86_64.deb.sha256
    - sudo dpkg -i bazel_0.2.2b-linux-x86_64.deb
  post:
    - echo 'startup --output_base /home/ubuntu/.cache/bazel/' > ~/.bazelrc
    # sandboxing does not work  --sandbox_debug
    - echo 'test --genrule_strategy=standalone --spawn_strategy=standalone' >> ~/.bazelrc
    - bazel fetch //test/...
  cache_directories:
    - "/home/ubuntu/.cache/bazel"

test:
  override:
    # circleci needs to mount ports so run one test at a time to avoid possible conflicts
    - bazel test --jobs 1 --verbose_failures //test/...
  post:
    - mkdir $CIRCLE_ARTIFACTS/bazel-testlogs
    - cp -a bazel-testlogs/. $CIRCLE_ARTIFACTS/bazel-testlogs
